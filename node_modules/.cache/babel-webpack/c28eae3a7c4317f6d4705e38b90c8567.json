{"ast":null,"code":"import _toConsumableArray from \"/media/diouf/Travail/Projets/projet web avance/angular/angularTest/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\nimport _createForOfIteratorHelper from \"/media/diouf/Travail/Projets/projet web avance/angular/angularTest/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper\";\nimport _regeneratorRuntime from \"/media/diouf/Travail/Projets/projet web avance/angular/angularTest/node_modules/@babel/runtime/regenerator\";\nimport _classCallCheck from \"/media/diouf/Travail/Projets/projet web avance/angular/angularTest/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/media/diouf/Travail/Projets/projet web avance/angular/angularTest/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport { __awaiter } from 'tslib';\nimport { Injectable, NgModule } from '@angular/core';\nimport { HttpHeaders, HTTP_INTERCEPTORS } from '@angular/common/http';\nimport { Subject, from } from 'rxjs';\nimport { map, mergeMap } from 'rxjs/operators';\nimport * as Keycloak_ from 'keycloak-js';\nimport { CommonModule } from '@angular/common';\nimport * as ɵngcc0 from '@angular/core';\n\nvar KeycloakEventType = /*@__PURE__*/function (KeycloakEventType) {\n  KeycloakEventType[KeycloakEventType[\"OnAuthError\"] = 0] = \"OnAuthError\";\n  KeycloakEventType[KeycloakEventType[\"OnAuthLogout\"] = 1] = \"OnAuthLogout\";\n  KeycloakEventType[KeycloakEventType[\"OnAuthRefreshError\"] = 2] = \"OnAuthRefreshError\";\n  KeycloakEventType[KeycloakEventType[\"OnAuthRefreshSuccess\"] = 3] = \"OnAuthRefreshSuccess\";\n  KeycloakEventType[KeycloakEventType[\"OnAuthSuccess\"] = 4] = \"OnAuthSuccess\";\n  KeycloakEventType[KeycloakEventType[\"OnReady\"] = 5] = \"OnReady\";\n  KeycloakEventType[KeycloakEventType[\"OnTokenExpired\"] = 6] = \"OnTokenExpired\";\n  return KeycloakEventType;\n}({});\n\nvar KeycloakAuthGuard = /*#__PURE__*/function () {\n  function KeycloakAuthGuard(router, keycloakAngular) {\n    _classCallCheck(this, KeycloakAuthGuard);\n\n    this.router = router;\n    this.keycloakAngular = keycloakAngular;\n  }\n\n  _createClass(KeycloakAuthGuard, [{\n    key: \"canActivate\",\n    value: function canActivate(route, state) {\n      var _this = this;\n\n      return new Promise(function (resolve, reject) {\n        return __awaiter(_this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n          var result;\n          return _regeneratorRuntime.wrap(function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  _context.prev = 0;\n                  _context.next = 3;\n                  return this.keycloakAngular.isLoggedIn();\n\n                case 3:\n                  this.authenticated = _context.sent;\n                  _context.next = 6;\n                  return this.keycloakAngular.getUserRoles(true);\n\n                case 6:\n                  this.roles = _context.sent;\n                  _context.next = 9;\n                  return this.isAccessAllowed(route, state);\n\n                case 9:\n                  result = _context.sent;\n                  resolve(result);\n                  _context.next = 16;\n                  break;\n\n                case 13:\n                  _context.prev = 13;\n                  _context.t0 = _context[\"catch\"](0);\n                  reject('An error happened during access validation. Details:' + _context.t0);\n\n                case 16:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }, _callee, this, [[0, 13]]);\n        }));\n      });\n    }\n  }]);\n\n  return KeycloakAuthGuard;\n}();\n\nvar Keycloak = Keycloak_;\n\nvar KeycloakService = /*@__PURE__*/function () {\n  var KeycloakService = /*#__PURE__*/function () {\n    function KeycloakService() {\n      _classCallCheck(this, KeycloakService);\n\n      this._keycloakEvents$ = new Subject();\n    }\n\n    _createClass(KeycloakService, [{\n      key: \"bindsKeycloakEvents\",\n      value: function bindsKeycloakEvents() {\n        var _this2 = this;\n\n        this._instance.onAuthError = function (errorData) {\n          _this2._keycloakEvents$.next({\n            args: errorData,\n            type: KeycloakEventType.OnAuthError\n          });\n        };\n\n        this._instance.onAuthLogout = function () {\n          _this2._keycloakEvents$.next({\n            type: KeycloakEventType.OnAuthLogout\n          });\n        };\n\n        this._instance.onAuthRefreshSuccess = function () {\n          _this2._keycloakEvents$.next({\n            type: KeycloakEventType.OnAuthRefreshSuccess\n          });\n        };\n\n        this._instance.onAuthRefreshError = function () {\n          _this2._keycloakEvents$.next({\n            type: KeycloakEventType.OnAuthRefreshError\n          });\n        };\n\n        this._instance.onAuthSuccess = function () {\n          _this2._keycloakEvents$.next({\n            type: KeycloakEventType.OnAuthSuccess\n          });\n        };\n\n        this._instance.onTokenExpired = function () {\n          _this2._keycloakEvents$.next({\n            type: KeycloakEventType.OnTokenExpired\n          });\n        };\n\n        this._instance.onReady = function (authenticated) {\n          _this2._keycloakEvents$.next({\n            args: authenticated,\n            type: KeycloakEventType.OnReady\n          });\n        };\n      }\n    }, {\n      key: \"loadExcludedUrls\",\n      value: function loadExcludedUrls(bearerExcludedUrls) {\n        var excludedUrls = [];\n\n        var _iterator = _createForOfIteratorHelper(bearerExcludedUrls),\n            _step;\n\n        try {\n          for (_iterator.s(); !(_step = _iterator.n()).done;) {\n            var item = _step.value;\n            var excludedUrl = void 0;\n\n            if (typeof item === 'string') {\n              excludedUrl = {\n                urlPattern: new RegExp(item, 'i'),\n                httpMethods: []\n              };\n            } else {\n              excludedUrl = {\n                urlPattern: new RegExp(item.url, 'i'),\n                httpMethods: item.httpMethods\n              };\n            }\n\n            excludedUrls.push(excludedUrl);\n          }\n        } catch (err) {\n          _iterator.e(err);\n        } finally {\n          _iterator.f();\n        }\n\n        return excludedUrls;\n      }\n    }, {\n      key: \"initServiceValues\",\n      value: function initServiceValues(_ref) {\n        var _ref$enableBearerInte = _ref.enableBearerInterceptor,\n            enableBearerInterceptor = _ref$enableBearerInte === void 0 ? true : _ref$enableBearerInte,\n            _ref$loadUserProfileA = _ref.loadUserProfileAtStartUp,\n            loadUserProfileAtStartUp = _ref$loadUserProfileA === void 0 ? false : _ref$loadUserProfileA,\n            _ref$bearerExcludedUr = _ref.bearerExcludedUrls,\n            bearerExcludedUrls = _ref$bearerExcludedUr === void 0 ? [] : _ref$bearerExcludedUr,\n            _ref$authorizationHea = _ref.authorizationHeaderName,\n            authorizationHeaderName = _ref$authorizationHea === void 0 ? 'Authorization' : _ref$authorizationHea,\n            _ref$bearerPrefix = _ref.bearerPrefix,\n            bearerPrefix = _ref$bearerPrefix === void 0 ? 'Bearer' : _ref$bearerPrefix,\n            initOptions = _ref.initOptions;\n        this._enableBearerInterceptor = enableBearerInterceptor;\n        this._loadUserProfileAtStartUp = loadUserProfileAtStartUp;\n        this._authorizationHeaderName = authorizationHeaderName;\n        this._bearerPrefix = bearerPrefix.trim().concat(' ');\n        this._excludedUrls = this.loadExcludedUrls(bearerExcludedUrls);\n        this._silentRefresh = initOptions ? initOptions.flow === 'implicit' : false;\n      }\n    }, {\n      key: \"init\",\n      value: function init() {\n        var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n        return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n          var config, initOptions, authenticated;\n          return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n            while (1) {\n              switch (_context2.prev = _context2.next) {\n                case 0:\n                  this.initServiceValues(options);\n                  config = options.config, initOptions = options.initOptions;\n                  this._instance = Keycloak(config);\n                  this.bindsKeycloakEvents();\n                  _context2.next = 6;\n                  return this._instance.init(initOptions);\n\n                case 6:\n                  authenticated = _context2.sent;\n\n                  if (!(authenticated && this._loadUserProfileAtStartUp)) {\n                    _context2.next = 10;\n                    break;\n                  }\n\n                  _context2.next = 10;\n                  return this.loadUserProfile();\n\n                case 10:\n                  return _context2.abrupt(\"return\", authenticated);\n\n                case 11:\n                case \"end\":\n                  return _context2.stop();\n              }\n            }\n          }, _callee2, this);\n        }));\n      }\n    }, {\n      key: \"login\",\n      value: function login() {\n        var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n        return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n          return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n            while (1) {\n              switch (_context3.prev = _context3.next) {\n                case 0:\n                  _context3.next = 2;\n                  return this._instance.login(options);\n\n                case 2:\n                  if (!this._loadUserProfileAtStartUp) {\n                    _context3.next = 5;\n                    break;\n                  }\n\n                  _context3.next = 5;\n                  return this.loadUserProfile();\n\n                case 5:\n                case \"end\":\n                  return _context3.stop();\n              }\n            }\n          }, _callee3, this);\n        }));\n      }\n    }, {\n      key: \"logout\",\n      value: function logout(redirectUri) {\n        return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n          var options;\n          return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n            while (1) {\n              switch (_context4.prev = _context4.next) {\n                case 0:\n                  options = {\n                    redirectUri: redirectUri\n                  };\n                  _context4.next = 3;\n                  return this._instance.logout(options);\n\n                case 3:\n                  this._userProfile = undefined;\n\n                case 4:\n                case \"end\":\n                  return _context4.stop();\n              }\n            }\n          }, _callee4, this);\n        }));\n      }\n    }, {\n      key: \"register\",\n      value: function register() {\n        var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {\n          action: 'register'\n        };\n        return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee5() {\n          return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n            while (1) {\n              switch (_context5.prev = _context5.next) {\n                case 0:\n                  _context5.next = 2;\n                  return this._instance.register(options);\n\n                case 2:\n                case \"end\":\n                  return _context5.stop();\n              }\n            }\n          }, _callee5, this);\n        }));\n      }\n    }, {\n      key: \"isUserInRole\",\n      value: function isUserInRole(role, resource) {\n        var hasRole;\n        hasRole = this._instance.hasResourceRole(role, resource);\n\n        if (!hasRole) {\n          hasRole = this._instance.hasRealmRole(role);\n        }\n\n        return hasRole;\n      }\n    }, {\n      key: \"getUserRoles\",\n      value: function getUserRoles() {\n        var allRoles = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n        var roles = [];\n\n        if (this._instance.resourceAccess) {\n          for (var key in this._instance.resourceAccess) {\n            if (this._instance.resourceAccess.hasOwnProperty(key)) {\n              var resourceAccess = this._instance.resourceAccess[key];\n              var clientRoles = resourceAccess['roles'] || [];\n              roles = roles.concat(clientRoles);\n            }\n          }\n        }\n\n        if (allRoles && this._instance.realmAccess) {\n          var _roles;\n\n          var realmRoles = this._instance.realmAccess['roles'] || [];\n\n          (_roles = roles).push.apply(_roles, _toConsumableArray(realmRoles));\n        }\n\n        return roles;\n      }\n    }, {\n      key: \"isLoggedIn\",\n      value: function isLoggedIn() {\n        return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee6() {\n          return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n            while (1) {\n              switch (_context6.prev = _context6.next) {\n                case 0:\n                  _context6.prev = 0;\n\n                  if (this._instance.authenticated) {\n                    _context6.next = 3;\n                    break;\n                  }\n\n                  return _context6.abrupt(\"return\", false);\n\n                case 3:\n                  _context6.next = 5;\n                  return this.updateToken(20);\n\n                case 5:\n                  return _context6.abrupt(\"return\", true);\n\n                case 8:\n                  _context6.prev = 8;\n                  _context6.t0 = _context6[\"catch\"](0);\n                  return _context6.abrupt(\"return\", false);\n\n                case 11:\n                case \"end\":\n                  return _context6.stop();\n              }\n            }\n          }, _callee6, this, [[0, 8]]);\n        }));\n      }\n    }, {\n      key: \"isTokenExpired\",\n      value: function isTokenExpired() {\n        var minValidity = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;\n        return this._instance.isTokenExpired(minValidity);\n      }\n    }, {\n      key: \"updateToken\",\n      value: function updateToken() {\n        var minValidity = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 5;\n        return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee7() {\n          return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n            while (1) {\n              switch (_context7.prev = _context7.next) {\n                case 0:\n                  if (!this._silentRefresh) {\n                    _context7.next = 4;\n                    break;\n                  }\n\n                  if (!this.isTokenExpired()) {\n                    _context7.next = 3;\n                    break;\n                  }\n\n                  throw new Error('Failed to refresh the token, or the session is expired');\n\n                case 3:\n                  return _context7.abrupt(\"return\", true);\n\n                case 4:\n                  if (this._instance) {\n                    _context7.next = 6;\n                    break;\n                  }\n\n                  throw new Error('Keycloak Angular library is not initialized.');\n\n                case 6:\n                  return _context7.abrupt(\"return\", this._instance.updateToken(minValidity));\n\n                case 7:\n                case \"end\":\n                  return _context7.stop();\n              }\n            }\n          }, _callee7, this);\n        }));\n      }\n    }, {\n      key: \"loadUserProfile\",\n      value: function loadUserProfile() {\n        var forceReload = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n        return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee8() {\n          return _regeneratorRuntime.wrap(function _callee8$(_context8) {\n            while (1) {\n              switch (_context8.prev = _context8.next) {\n                case 0:\n                  if (!(this._userProfile && !forceReload)) {\n                    _context8.next = 2;\n                    break;\n                  }\n\n                  return _context8.abrupt(\"return\", this._userProfile);\n\n                case 2:\n                  if (this._instance.authenticated) {\n                    _context8.next = 4;\n                    break;\n                  }\n\n                  throw new Error('The user profile was not loaded as the user is not logged in.');\n\n                case 4:\n                  _context8.next = 6;\n                  return this._instance.loadUserProfile();\n\n                case 6:\n                  return _context8.abrupt(\"return\", this._userProfile = _context8.sent);\n\n                case 7:\n                case \"end\":\n                  return _context8.stop();\n              }\n            }\n          }, _callee8, this);\n        }));\n      }\n    }, {\n      key: \"getToken\",\n      value: function getToken() {\n        return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee9() {\n          return _regeneratorRuntime.wrap(function _callee9$(_context9) {\n            while (1) {\n              switch (_context9.prev = _context9.next) {\n                case 0:\n                  _context9.next = 2;\n                  return this.updateToken(10);\n\n                case 2:\n                  return _context9.abrupt(\"return\", this._instance.token);\n\n                case 3:\n                case \"end\":\n                  return _context9.stop();\n              }\n            }\n          }, _callee9, this);\n        }));\n      }\n    }, {\n      key: \"getUsername\",\n      value: function getUsername() {\n        if (!this._userProfile) {\n          throw new Error('User not logged in or user profile was not loaded.');\n        }\n\n        return this._userProfile.username;\n      }\n    }, {\n      key: \"clearToken\",\n      value: function clearToken() {\n        this._instance.clearToken();\n      }\n    }, {\n      key: \"addTokenToHeader\",\n      value: function addTokenToHeader() {\n        var _this3 = this;\n\n        var headers = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : new HttpHeaders();\n        return from(this.getToken()).pipe(map(function (token) {\n          return token ? headers.set(_this3._authorizationHeaderName, _this3._bearerPrefix + token) : headers;\n        }));\n      }\n    }, {\n      key: \"getKeycloakInstance\",\n      value: function getKeycloakInstance() {\n        return this._instance;\n      }\n    }, {\n      key: \"excludedUrls\",\n      get: function get() {\n        return this._excludedUrls;\n      }\n    }, {\n      key: \"enableBearerInterceptor\",\n      get: function get() {\n        return this._enableBearerInterceptor;\n      }\n    }, {\n      key: \"keycloakEvents$\",\n      get: function get() {\n        return this._keycloakEvents$;\n      }\n    }]);\n\n    return KeycloakService;\n  }();\n\n  KeycloakService.ɵfac = function KeycloakService_Factory(t) {\n    return new (t || KeycloakService)();\n  };\n\n  KeycloakService.ɵprov = /*@__PURE__*/ɵngcc0.ɵɵdefineInjectable({\n    token: KeycloakService,\n    factory: KeycloakService.ɵfac\n  });\n  return KeycloakService;\n}();\n\nvar KeycloakBearerInterceptor = /*@__PURE__*/function () {\n  var KeycloakBearerInterceptor = /*#__PURE__*/function () {\n    function KeycloakBearerInterceptor(keycloak) {\n      _classCallCheck(this, KeycloakBearerInterceptor);\n\n      this.keycloak = keycloak;\n    }\n\n    _createClass(KeycloakBearerInterceptor, [{\n      key: \"isUrlExcluded\",\n      value: function isUrlExcluded(_ref2, _ref3) {\n        var method = _ref2.method,\n            url = _ref2.url;\n        var urlPattern = _ref3.urlPattern,\n            httpMethods = _ref3.httpMethods;\n        var httpTest = httpMethods.length === 0 || httpMethods.join().indexOf(method.toUpperCase()) > -1;\n        var urlTest = urlPattern.test(url);\n        return httpTest && urlTest;\n      }\n    }, {\n      key: \"intercept\",\n      value: function intercept(req, next) {\n        var _this4 = this;\n\n        var _this$keycloak = this.keycloak,\n            enableBearerInterceptor = _this$keycloak.enableBearerInterceptor,\n            excludedUrls = _this$keycloak.excludedUrls;\n\n        if (!enableBearerInterceptor) {\n          return next.handle(req);\n        }\n\n        var shallPass = excludedUrls.findIndex(function (item) {\n          return _this4.isUrlExcluded(req, item);\n        }) > -1;\n\n        if (shallPass) {\n          return next.handle(req);\n        }\n\n        return from(this.keycloak.isLoggedIn()).pipe(mergeMap(function (loggedIn) {\n          return loggedIn ? _this4.handleRequestWithTokenHeader(req, next) : next.handle(req);\n        }));\n      }\n    }, {\n      key: \"handleRequestWithTokenHeader\",\n      value: function handleRequestWithTokenHeader(req, next) {\n        return this.keycloak.addTokenToHeader(req.headers).pipe(mergeMap(function (headersWithBearer) {\n          var kcReq = req.clone({\n            headers: headersWithBearer\n          });\n          return next.handle(kcReq);\n        }));\n      }\n    }]);\n\n    return KeycloakBearerInterceptor;\n  }();\n\n  KeycloakBearerInterceptor.ɵfac = function KeycloakBearerInterceptor_Factory(t) {\n    return new (t || KeycloakBearerInterceptor)(ɵngcc0.ɵɵinject(KeycloakService));\n  };\n\n  KeycloakBearerInterceptor.ɵprov = /*@__PURE__*/ɵngcc0.ɵɵdefineInjectable({\n    token: KeycloakBearerInterceptor,\n    factory: KeycloakBearerInterceptor.ɵfac\n  });\n  return KeycloakBearerInterceptor;\n}();\n\nvar CoreModule = /*@__PURE__*/function () {\n  var CoreModule = function CoreModule() {\n    _classCallCheck(this, CoreModule);\n  };\n\n  CoreModule.ɵmod = /*@__PURE__*/ɵngcc0.ɵɵdefineNgModule({\n    type: CoreModule\n  });\n  CoreModule.ɵinj = /*@__PURE__*/ɵngcc0.ɵɵdefineInjector({\n    factory: function CoreModule_Factory(t) {\n      return new (t || CoreModule)();\n    },\n    providers: [KeycloakService, {\n      provide: HTTP_INTERCEPTORS,\n      useClass: KeycloakBearerInterceptor,\n      multi: true\n    }],\n    imports: [[CommonModule]]\n  });\n  return CoreModule;\n}();\n/*@__PURE__*/\n\n\n(function () {\n  (typeof ngJitMode === \"undefined\" || ngJitMode) && ɵngcc0.ɵɵsetNgModuleScope(CoreModule, {\n    imports: function imports() {\n      return [CommonModule];\n    }\n  });\n})();\n\nvar KeycloakAngularModule = /*@__PURE__*/function () {\n  var KeycloakAngularModule = function KeycloakAngularModule() {\n    _classCallCheck(this, KeycloakAngularModule);\n  };\n\n  KeycloakAngularModule.ɵmod = /*@__PURE__*/ɵngcc0.ɵɵdefineNgModule({\n    type: KeycloakAngularModule\n  });\n  KeycloakAngularModule.ɵinj = /*@__PURE__*/ɵngcc0.ɵɵdefineInjector({\n    factory: function KeycloakAngularModule_Factory(t) {\n      return new (t || KeycloakAngularModule)();\n    },\n    imports: [[CoreModule]]\n  });\n  return KeycloakAngularModule;\n}();\n/*@__PURE__*/\n\n\n(function () {\n  (typeof ngJitMode === \"undefined\" || ngJitMode) && ɵngcc0.ɵɵsetNgModuleScope(KeycloakAngularModule, {\n    imports: [CoreModule]\n  });\n})();\n\nexport { CoreModule, KeycloakAngularModule, KeycloakAuthGuard, KeycloakBearerInterceptor, KeycloakEventType, KeycloakService };","map":null,"metadata":{},"sourceType":"module"}